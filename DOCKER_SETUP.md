# Vampire Raiders - Docker Setup Guide

This guide will help you and your friends get the Vampire Raiders server running locally with a single command.

## Prerequisites

You only need to have **Docker** and **Docker Compose** installed:
- Download Docker Desktop: https://www.docker.com/products/docker-desktop

That's it! No need to install Java, MySQL, or any other dependencies manually.

## Quick Start

### 1. Start the Full Stack (Database + Backend)

From the project root directory (`poc-vampire-raiders/`), run:

```bash
docker-compose up --build
```

This will:
- âœ… Build the Java backend with Java 25
- âœ… Start MySQL database
- âœ… Initialize the database schema with `init.sql`
- âœ… Start the game server on port `7777`
- âœ… Wait for database to be ready before starting backend

### 2. Connect Godot Client

Once you see the message `[NETWORK] Game loop started at 60 ticks/second` in the terminal, the server is ready!

Open the Godot project and connect to `localhost:7777` (or your server IP if testing on another machine).

## Docker Compose Structure

### MySQL Database Service
- **Container**: `vampire-raiders-mysql`
- **Port**: 3306 (internal to Docker network)
- **Credentials**:
  - Root: `rootpassword`
  - User: `game_user` / `gamepassword`
  - Database: `vampire_raiders`
- **Persistence**: Data saved in `mysql_data` volume

### Java Backend Service
- **Container**: `vampire-raiders-backend`
- **Port**: 7777 (exposed to host)
- **Dependencies**: Waits for MySQL to be healthy
- **Auto-build**: Runs Maven to compile and package on first run
- **Auto-restart**: Restarts if it crashes

## Useful Commands

### Start services in background:
```bash
docker-compose up -d --build
```

### View logs:
```bash
docker-compose logs -f java-backend
docker-compose logs -f mysql
```

### Stop all services:
```bash
docker-compose down
```

### Stop and remove all data (clean slate):
```bash
docker-compose down -v
```

### Rebuild without cache:
```bash
docker-compose up --build --no-cache
```

### Check container status:
```bash
docker-compose ps
```

## Troubleshooting

### "Port 3306 already in use"
Another MySQL instance is running. Either:
- Stop it: `docker-compose down -v`
- Change port in docker-compose.yml (line 19): `"3307:3306"`

### "Port 7777 already in use"
Change the port in docker-compose.yml (line 54): `"7778:7777"` then connect to that port in Godot.

### "Database connection failed"
Wait for the healthcheck to pass. Check logs:
```bash
docker-compose logs mysql
```

### "Java compilation failed"
Check if `pom.xml` is valid:
```bash
docker-compose logs java-backend
```

## Network Setup for Friends

### Local Testing (Same Machine)
Godot Client â†’ `localhost:7777`

### Local Network Testing (Same WiFi/LAN)
1. Find your machine's IP: 
   - Windows: `ipconfig` (look for IPv4 Address)
   - Mac/Linux: `ifconfig` (look for inet)
2. Share that IP with friends
3. They connect to `YOUR_IP:7777` in Godot

### Internet Testing (Across Internet)
Use port forwarding on your router or ngrok:
```bash
docker run -it -e NGROK_AUTHTOKEN=your_token ngrok/ngrok:latest tcp 7777
```

## File Structure

```
poc-vampire-raiders/
â”œâ”€â”€ docker-compose.yml          â† Main compose file (run from here!)
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ docker-compose.yml      â† Old database-only compose (deprecated)
â”‚   â””â”€â”€ init.sql               â† Database schema
â”œâ”€â”€ poc-java-backend/
â”‚   â”œâ”€â”€ Dockerfile             â† Java backend container definition
â”‚   â”œâ”€â”€ pom.xml               â† Maven dependencies
â”‚   â”œâ”€â”€ src/                  â† Java source code
â”‚   â””â”€â”€ target/               â† Compiled JAR (generated by Docker)
â””â”€â”€ poc-godot/
    â””â”€â”€ poc-vampire-raiders-multiplayer/
        â””â”€â”€ (Godot project - run in editor or export)
```

## Performance Tips

- **For slower machines**: Increase build timeout in Dockerfile or use pre-built images
- **RAM Issues**: Adjust `JAVA_OPTS` in docker-compose.yml to reduce heap size
- **Network latency**: Reduce `PLAYER_SAVE_INTERVAL_MS` in GameWorld.java if needed

## Development Workflow

### Making Java Changes
1. Edit code in `poc-java-backend/src/`
2. Restart: `docker-compose restart java-backend` (rebuilds if needed)
3. Or force rebuild: `docker-compose up --build java-backend`

### Making Database Changes
1. Edit `database/init.sql`
2. Stop and remove: `docker-compose down -v`
3. Restart: `docker-compose up --build`

## Environment Variables

You can override settings by creating a `.env` file:

```env
MYSQL_ROOT_PASSWORD=your_password
MYSQL_USER=your_user
MYSQL_PASSWORD=your_password
JAVA_OPTS=-Xmx1g -Xms512m
```

Then run: `docker-compose --env-file .env up`

---

**Happy testing! ğŸ®**
